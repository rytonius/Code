#!ps
#timeout=3000000
#maxlength=60000
#https://support.malwarebytes.com/hc/en-us/articles/360038524734-Malwarebytes-Support-Tool-for-business-environments
#WARNING THIS WILL REBOOT THE COMPUTER
function Uninstall-MalwareBytesREBOOT {
    [CmdletBinding()]
    param (
        [Parameter()]
        [string]$url = "https://data-cdn.mbamupdates.com/web/mbstcmd/mbstcmd-1.0.6.152.exe",
        [Parameter()]
        [string]$dir = "#"
    )
    begin {
        if ((Get-CimInstance -classname cim_operatingsystem).caption -like "*server*") {write-warning "server, breaking";break} else {"`nNon-Server, continue with script`n"}
        if (get-process "*mbam*") {write-host "detected malwarebytes, continueing"} else {write-warning "`nmalwarebytes not detected, breaking`n"; break}
        if (test-path #) {write-host "packages dir exists"} else {New-Item -ItemType Directory "#"}
        #tls must be 1.2 for start-bitstransfer to work
        write-host "`nchecking Security Protocol: $([System.Net.ServicePointManager]::SecurityProtocol) `n`n" ;
       
        if ([System.Net.ServicePointManager]::SecurityProtocol -like "*tls12*" -or [System.Net.ServicePointManager]::SecurityProtocol -like "SystemDefault" ) {write-host "`nTLS 1.2 is enabled for Powershell`n`n`n" -ForegroundColor green;} else {[System.Net.ServicePointManager]::SecurityProtocol += [System.Net.SecurityProtocolType]::tls12; Write-Warning "TLS 1.2 wasn't enabled on powershell, enabling now"; write-host "#$($attemptsTLS) checking again now Security Protocol: $([System.Net.ServicePointManager]::SecurityProtocol)";}
    }
    
    process {

        try {Start-BitsTransfer -Source $url -Destination $dir} 
        catch {
            write-warning "`nnon windows 10, using net.webclient`n"
            $dir = "#"
            (new-object net.webclient).downloadfile($url,$dir)
        }
        set-location "#"
        #WARNING THIS WILL REBOOT THE COMPUTER
        .\mbstcmd-1.0.6.152.exe /y /cleanup
        get-process "*mbam*" 
    }
    
    end { 
        start-sleep -seconds 60
        if (get-process "mbam*") {write-host "detected malwarebytes process, continuing"} else {write-warning "`nmalwarebytes not detected, breaking`n"; break}
        #if (get-childitem "c:\program files\malwarebytes\anti-malware\") {"detected directory, rebooting"; shutdown /r /t 60} else {"no files, no reboot"}
    }
    
}

Uninstall-MalwareBytesREBOOT
